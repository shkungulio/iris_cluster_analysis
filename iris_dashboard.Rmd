---
title: "IRIS Clusters Analysis Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#101010"
      fg: "#FDF7F7" 
      primary: "#ED79F9"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
# Install thematic and un-comment for themed static plots (i.e., ggplot2)
# thematic::thematic_rmd()
```

```{r}
# Core packages
library(flexdashboard)
library(tidyverse)
library(cluster)
library(factoextra)
library(fpc)
library(DT)
library(plotly)

# -------------------------------------------------------------------

# Data & model objects (re-using your saved deployment artifacts)

# -------------------------------------------------------------------

data(iris)


# Numeric features only (same as in your report)

iris_features <- iris %>%
select(Sepal.Length, Sepal.Width, Petal.Length, Petal.Width)


# Load saved scaling parameters and trained K-Means model

scale_center <- readRDS("resources/scale_center.rds")
scale_scale  <- readRDS("resources/scale_scale.rds")
kmeans_model <- readRDS("resources/kmeans_model.rds")


# Apply the same standardization used in the analysis

iris_scaled <- scale(
iris_features,
center = scale_center,
scale  = scale_scale
)


# Attach clusters back to original data

iris_kmeans <- iris %>%
mutate(
KMeansCluster = factor(kmeans_model$cluster),
Species       = Species
)


# Distance matrix for cluster diagnostics

dist_iris <- dist(iris_scaled)


# Silhouette for k = 3 (your chosen k)

sil_obj <- cluster::silhouette(kmeans_model$cluster, dist_iris)
avg_sil_width <- mean(sil_obj[, "sil_width"])


# Adjusted Rand Index helper

compute_ari <- function(cluster_labels, dist_matrix, true_labels) {
cluster.stats(
d              = dist_matrix,
clustering     = cluster_labels,
alt.clustering = as.numeric(true_labels)
)$corrected.rand
}

ari_kmeans <- compute_ari(kmeans_model$cluster, dist_iris, iris$Species)


# PCA for visualization (same approach as in your report)

pca_model <- prcomp(iris_scaled, center = TRUE, scale. = TRUE)

pca_data <- as_tibble(pca_model$x[, 1:2]) %>%
mutate(
Cluster = factor(kmeans_model$cluster),
Species = iris$Species
)


# Cluster centers as tibble (for display)
centers_tbl <- as_tibble(kmeans_model$centers) %>%
mutate(Cluster = factor(row_number())) %>%
relocate(Cluster)
```

```{r}
# Shared reactive filters for the whole dashboard
filtered_data <- reactive({
df <- iris_kmeans

# Filter by species (if user selected any)
if (!is.null(input$species_filter) && length(input$species_filter) > 0) {
df <- df %>% filter(Species %in% input$species_filter)
}


# Filter by cluster (if user selected any)
if (!is.null(input$cluster_filter) && length(input$cluster_filter) > 0) {
df <- df %>% filter(KMeansCluster %in% input$cluster_filter)
}

df
})

filtered_pca <- reactive({
df <- pca_data

if (!is.null(input$species_filter) && length(input$species_filter) > 0) {
df <- df %>% filter(Species %in% input$species_filter)
}

if (!is.null(input$cluster_filter) && length(input$cluster_filter) > 0) {
df <- df %>% filter(Cluster %in% input$cluster_filter)
}

df
})
```


## Row
Dataset Overview
```{r}
valueBox(
value   = nrow(iris),
caption = "Total Observations",
icon    = "fa-database"
)

valueBox(
value   = length(unique(iris$Species)),
caption = "True Species",
icon    = "fa-leaf"
)

valueBox(
value   = length(unique(kmeans_model$cluster)),
caption = "K-Means Clusters (k)",
icon    = "fa-object-group"
)
```

Cluster Quality
```{r}
valueBox(
value   = sprintf("%.3f", ari_kmeans),
caption = "Adjusted Rand Index (Clusters vs Species)",
icon    = "fa-check-circle"
)

valueBox(
value   = sprintf("%.3f", avg_sil_width),
caption = "Average Silhouette Width (k = 3)",
icon    = "fa-chart-line"
)

```








